<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAI-Net Training Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .status-bar {
            background-color: #2d2d2d;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #404040;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.active {
            background-color: #4ade80;
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.5);
        }

        .status-dot.paused {
            background-color: #fbbf24;
        }

        .status-dot.error {
            background-color: #f87171;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .controls {
            background-color: #2d2d2d;
            padding: 20px;
            border-bottom: 2px solid #404040;
        }

        .controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 500;
            color: #d1d5db;
        }

        .control-group select, .control-group input {
            padding: 8px 12px;
            background-color: #404040;
            border: 1px solid #555;
            border-radius: 4px;
            color: white;
            font-size: 14px;
        }

        .metrics-toggles {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .metric-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background-color: #404040;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .metric-toggle:hover {
            background-color: #4a4a4a;
        }

        .metric-toggle input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }

        .metric-toggle.active {
            background-color: #4f46e5;
        }

        .chart-container {
            padding: 20px;
            background-color: #1a1a1a;
        }

        .chart-wrapper {
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.5em;
            margin-bottom: 15px;
            text-align: center;
            color: #e5e7eb;
        }

        .chart-canvas {
            position: relative;
            height: 400px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #6366f1;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #60a5fa;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #d1d5db;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .footer {
            background-color: #2d2d2d;
            padding: 15px;
            text-align: center;
            color: #9ca3af;
            font-size: 0.9em;
            border-top: 2px solid #404040;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            font-size: 1.2em;
            color: #9ca3af;
        }

        .error-message {
            background-color: #7f1d1d;
            border: 1px solid #b91c1c;
            padding: 15px;
            border-radius: 6px;
            margin: 20px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .metrics-toggles {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ”¥ SAI-Net Training Monitor</h1>
        <div class="subtitle">Real-time YOLOv8 Training Metrics Dashboard</div>
    </div>

    <div class="status-bar">
        <div class="status-indicator">
            <div class="status-dot active" id="statusDot"></div>
            <span id="statusText">Training Active</span>
        </div>
        <div id="lastUpdate">Last Update: --</div>
        <div id="refreshCounter">Next refresh in: --</div>
    </div>

    <div class="controls">
        <div class="controls-row">
            <div class="control-group">
                <label for="refreshRate">Refresh Rate:</label>
                <select id="refreshRate">
                    <option value="5000">5 seconds</option>
                    <option value="10000" selected>10 seconds</option>
                    <option value="30000">30 seconds</option>
                    <option value="60000">1 minute</option>
                    <option value="300000">5 minutes</option>
                </select>
            </div>
            <div class="control-group">
                <label for="maxEpochs">Max Epochs to Show:</label>
                <input type="number" id="maxEpochs" value="50" min="10" max="500">
            </div>
            <button id="pauseBtn" style="padding: 8px 16px; background-color: #f59e0b; border: none; border-radius: 4px; color: white; cursor: pointer;">Pause</button>
        </div>
        
        <div class="metrics-toggles" id="metricsToggles">
            <!-- Dynamically populated -->
        </div>
    </div>

    <div class="chart-container">
        <div class="stats-grid" id="statsGrid">
            <!-- Dynamically populated -->
        </div>

        <div class="chart-wrapper">
            <h3 class="chart-title">Training & Validation Losses</h3>
            <div class="chart-canvas">
                <canvas id="lossChart"></canvas>
            </div>
        </div>

        <div class="chart-wrapper">
            <h3 class="chart-title">Performance Metrics</h3>
            <div class="chart-canvas">
                <canvas id="metricsChart"></canvas>
            </div>
        </div>

        <div class="chart-wrapper">
            <h3 class="chart-title">Learning Rates</h3>
            <div class="chart-canvas">
                <canvas id="lrChart"></canvas>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>SAI-Net Detector Training Monitor | Updates automatically from runs/h200_stage1_fasdd7/results.csv</p>
    </div>

    <script>
        class TrainingMonitor {
            constructor() {
                this.csvPath = 'runs/h200_stage1_fasdd7/results.csv';
                this.refreshRate = 10000; // 10 seconds
                this.isPaused = false;
                this.data = [];
                this.charts = {};
                this.refreshTimer = null;
                this.countdownTimer = null;
                this.nextRefreshTime = 0;
                
                this.metricConfigs = {
                    'train/box_loss': { color: '#ef4444', enabled: true, chart: 'loss' },
                    'train/cls_loss': { color: '#f59e0b', enabled: true, chart: 'loss' },
                    'train/dfl_loss': { color: '#10b981', enabled: true, chart: 'loss' },
                    'val/box_loss': { color: '#ef4444', enabled: true, chart: 'loss', borderDash: [5, 5] },
                    'val/cls_loss': { color: '#f59e0b', enabled: true, chart: 'loss', borderDash: [5, 5] },
                    'val/dfl_loss': { color: '#10b981', enabled: true, chart: 'loss', borderDash: [5, 5] },
                    'metrics/precision(B)': { color: '#3b82f6', enabled: true, chart: 'metrics' },
                    'metrics/recall(B)': { color: '#8b5cf6', enabled: true, chart: 'metrics' },
                    'metrics/mAP50(B)': { color: '#06b6d4', enabled: true, chart: 'metrics' },
                    'metrics/mAP50-95(B)': { color: '#84cc16', enabled: true, chart: 'metrics' },
                    'lr/pg0': { color: '#f97316', enabled: true, chart: 'lr' },
                    'lr/pg1': { color: '#ec4899', enabled: false, chart: 'lr' },
                    'lr/pg2': { color: '#14b8a6', enabled: false, chart: 'lr' }
                };

                this.init();
            }

            init() {
                this.setupEventListeners();
                this.createMetricToggles();
                this.initCharts();
                this.loadData();
                this.startRefreshTimer();
            }

            setupEventListeners() {
                document.getElementById('refreshRate').addEventListener('change', (e) => {
                    this.refreshRate = parseInt(e.target.value);
                    this.startRefreshTimer();
                });

                document.getElementById('pauseBtn').addEventListener('click', () => {
                    this.togglePause();
                });

                document.getElementById('maxEpochs').addEventListener('change', () => {
                    this.updateCharts();
                });
            }

            createMetricToggles() {
                const container = document.getElementById('metricsToggles');
                container.innerHTML = '';

                Object.entries(this.metricConfigs).forEach(([metric, config]) => {
                    const toggle = document.createElement('div');
                    toggle.className = `metric-toggle ${config.enabled ? 'active' : ''}`;
                    
                    toggle.innerHTML = `
                        <input type="checkbox" id="toggle_${metric}" ${config.enabled ? 'checked' : ''}>
                        <label for="toggle_${metric}" style="color: ${config.color}; cursor: pointer;">
                            ${metric.replace('metrics/', '').replace('(B)', '')}
                        </label>
                    `;

                    toggle.addEventListener('click', (e) => {
                        if (e.target.type !== 'checkbox') {
                            const checkbox = toggle.querySelector('input');
                            checkbox.checked = !checkbox.checked;
                        }
                        
                        const checkbox = toggle.querySelector('input');
                        config.enabled = checkbox.checked;
                        toggle.className = `metric-toggle ${config.enabled ? 'active' : ''}`;
                        this.updateCharts();
                    });

                    container.appendChild(toggle);
                });
            }

            initCharts() {
                const commonOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Epoch',
                                color: '#d1d5db'
                            },
                            grid: {
                                color: '#374151'
                            },
                            ticks: {
                                color: '#d1d5db'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                color: '#d1d5db'
                            },
                            grid: {
                                color: '#374151'
                            },
                            ticks: {
                                color: '#d1d5db'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#d1d5db',
                                usePointStyle: true
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 2,
                            hoverRadius: 5
                        },
                        line: {
                            borderWidth: 2,
                            tension: 0.1
                        }
                    }
                };

                // Loss Chart
                this.charts.loss = new Chart(document.getElementById('lossChart'), {
                    type: 'line',
                    data: { datasets: [] },
                    options: {
                        ...commonOptions,
                        scales: {
                            ...commonOptions.scales,
                            y: {
                                ...commonOptions.scales.y,
                                title: {
                                    display: true,
                                    text: 'Loss Value',
                                    color: '#d1d5db'
                                }
                            }
                        }
                    }
                });

                // Metrics Chart
                this.charts.metrics = new Chart(document.getElementById('metricsChart'), {
                    type: 'line',
                    data: { datasets: [] },
                    options: {
                        ...commonOptions,
                        scales: {
                            ...commonOptions.scales,
                            y: {
                                ...commonOptions.scales.y,
                                title: {
                                    display: true,
                                    text: 'Metric Value',
                                    color: '#d1d5db'
                                },
                                min: 0,
                                max: 1
                            }
                        }
                    }
                });

                // Learning Rate Chart
                this.charts.lr = new Chart(document.getElementById('lrChart'), {
                    type: 'line',
                    data: { datasets: [] },
                    options: {
                        ...commonOptions,
                        scales: {
                            ...commonOptions.scales,
                            y: {
                                ...commonOptions.scales.y,
                                title: {
                                    display: true,
                                    text: 'Learning Rate',
                                    color: '#d1d5db'
                                },
                                type: 'logarithmic'
                            }
                        }
                    }
                });
            }

            async loadData() {
                try {
                    const response = await fetch(this.csvPath + '?t=' + Date.now());
                    const text = await response.text();
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const lines = text.trim().split('\n');
                    if (lines.length < 2) {
                        throw new Error('Invalid CSV format');
                    }

                    const headers = lines[0].split(',');
                    this.data = [];

                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',');
                        if (values.length === headers.length) {
                            const row = {};
                            headers.forEach((header, index) => {
                                const value = values[index];
                                row[header] = isNaN(value) ? value : parseFloat(value);
                            });
                            this.data.push(row);
                        }
                    }

                    this.updateStatus('active', 'Training Active');
                    this.updateCharts();
                    this.updateStats();
                    document.getElementById('lastUpdate').textContent = 
                        `Last Update: ${new Date().toLocaleTimeString()}`;
                    
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.updateStatus('error', `Error: ${error.message}`);
                    this.showError(`Failed to load training data: ${error.message}`);
                }
            }

            updateCharts() {
                const maxEpochs = parseInt(document.getElementById('maxEpochs').value);
                const filteredData = this.data.slice(-maxEpochs);

                Object.entries(this.charts).forEach(([chartType, chart]) => {
                    const datasets = [];
                    
                    Object.entries(this.metricConfigs).forEach(([metric, config]) => {
                        if (config.enabled && config.chart === chartType) {
                            const data = filteredData.map(row => ({
                                x: row.epoch,
                                y: row[metric]
                            })).filter(point => point.y !== undefined);

                            if (data.length > 0) {
                                datasets.push({
                                    label: metric.replace('metrics/', '').replace('(B)', ''),
                                    data: data,
                                    borderColor: config.color,
                                    backgroundColor: config.color + '20',
                                    borderDash: config.borderDash || [],
                                    fill: false
                                });
                            }
                        }
                    });

                    chart.data.datasets = datasets;
                    chart.update('none');
                });
            }

            updateStats() {
                if (this.data.length === 0) return;

                const latest = this.data[this.data.length - 1];
                const statsGrid = document.getElementById('statsGrid');
                
                const stats = [
                    { label: 'Current Epoch', value: latest.epoch || '--', format: 'int' },
                    { label: 'mAP@0.5', value: latest['metrics/mAP50(B)'], format: 'percent' },
                    { label: 'mAP@0.5-0.95', value: latest['metrics/mAP50-95(B)'], format: 'percent' },
                    { label: 'Precision', value: latest['metrics/precision(B)'], format: 'percent' },
                    { label: 'Recall', value: latest['metrics/recall(B)'], format: 'percent' },
                    { label: 'Box Loss', value: latest['train/box_loss'], format: 'float' },
                    { label: 'Cls Loss', value: latest['train/cls_loss'], format: 'float' },
                    { label: 'Learning Rate', value: latest['lr/pg0'], format: 'scientific' }
                ];

                statsGrid.innerHTML = stats.map(stat => {
                    let displayValue = '--';
                    if (stat.value !== undefined && stat.value !== null) {
                        switch (stat.format) {
                            case 'percent':
                                displayValue = (stat.value * 100).toFixed(1) + '%';
                                break;
                            case 'float':
                                displayValue = stat.value.toFixed(3);
                                break;
                            case 'scientific':
                                displayValue = stat.value.toExponential(2);
                                break;
                            case 'int':
                                displayValue = Math.round(stat.value);
                                break;
                            default:
                                displayValue = stat.value;
                        }
                    }

                    return `
                        <div class="stat-card">
                            <div class="stat-value">${displayValue}</div>
                            <div class="stat-label">${stat.label}</div>
                        </div>
                    `;
                }).join('');
            }

            updateStatus(type, text) {
                const dot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                
                dot.className = `status-dot ${type}`;
                statusText.textContent = text;
            }

            showError(message) {
                const existing = document.querySelector('.error-message');
                if (existing) existing.remove();

                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = message;
                document.querySelector('.chart-container').prepend(errorDiv);

                setTimeout(() => errorDiv.remove(), 10000);
            }

            startRefreshTimer() {
                if (this.refreshTimer) clearInterval(this.refreshTimer);
                if (this.countdownTimer) clearInterval(this.countdownTimer);

                if (!this.isPaused) {
                    this.nextRefreshTime = Date.now() + this.refreshRate;
                    
                    this.refreshTimer = setInterval(() => {
                        this.loadData();
                        this.nextRefreshTime = Date.now() + this.refreshRate;
                    }, this.refreshRate);

                    this.countdownTimer = setInterval(() => {
                        const remaining = Math.max(0, this.nextRefreshTime - Date.now());
                        const seconds = Math.ceil(remaining / 1000);
                        document.getElementById('refreshCounter').textContent = 
                            `Next refresh in: ${seconds}s`;
                    }, 1000);
                }
            }

            togglePause() {
                this.isPaused = !this.isPaused;
                const btn = document.getElementById('pauseBtn');
                
                if (this.isPaused) {
                    btn.textContent = 'Resume';
                    btn.style.backgroundColor = '#10b981';
                    this.updateStatus('paused', 'Monitoring Paused');
                    if (this.refreshTimer) clearInterval(this.refreshTimer);
                    if (this.countdownTimer) clearInterval(this.countdownTimer);
                    document.getElementById('refreshCounter').textContent = 'Monitoring paused';
                } else {
                    btn.textContent = 'Pause';
                    btn.style.backgroundColor = '#f59e0b';
                    this.updateStatus('active', 'Training Active');
                    this.startRefreshTimer();
                }
            }
        }

        // Initialize the monitor when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new TrainingMonitor();
        });
    </script>
</body>
</html>